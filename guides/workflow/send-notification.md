---
category: Workflow
expires: 2020-12-31
order: 7
---
# Sending a notification using AWS SES/SMS

## Introduction

There is a subprocess that you can set up in your BPMN that sends an email and/or text message to named recipient/s using AWS SES/SMS. As with the PDF subprocess, this subprocess is a self-contained, reusable component that can be incorporated into the BPMN for any workflow. The same subprocess is used whether you want to generate an email, or a text message, or both.


**Do not define activities in your BPMN to send a notification because the sub-process does it for you.**   

## How to configure the send notification subprocesses

You will have built a BPMN for your form [in the usual way]({{'/guides/workflow/simple-form-bpmn' | relative_url }}).

In order for your BPMN to create an email/text notification you need to drag and drop a 'Create Task' icon onto your diagram. Click on the 'spanner' icon to change the type to 'Call Activity'.

![call activity configurations]({{'/images/call-activity-notification.jpeg' | relative_url }})

**Figure 1. 'Call activity' configuration**

![send notification BPMN]({{'/images/send-notifications-bpmn.jpeg' | relative_url }})

**Figure 2. 'Call activity' containing the 'Send notification' subprocess**

Then fill in the 'Call activity' details panel. You need to specify which 'Call activity' you want to apply. First fill in the type of call activity you are invoking. To do this select BPMN from the drop-down list. Then in the 'Called Element' input box, type 'send-notifications'. **You need to tick the 'Business Key' check box.** This will populate the 'Business Key Expression' box:

```
#{execution.processBusinessKey}
```

The 'Business Key' is autogenerated when a user submits a form. This is to enable 'Case View'. When a 'Business Key' is inputted into 'Case View' it will then return all process instances associated with that key. This provides a full audit trail for every case.  

![send notification details panel]({{'/images/send-notifications-details-panel.jpeg' | relative_url }})

**Figure 3. Call activity details panel on the 'General' tab**

At this point you have configured your BPMN to call your reusable subprocess. If you stopped here the reusable subprocess would be called but then it would do nothing because it needs two variable input parameters.

### Variable input mapping

On the 'Variables' tabs of the 'Call activity' you are going to configure the input mappings for the subprocess, i.e. you are going to give the subprocess a set of data for it to execute.
The subprocess needs two pieces of data.

* 'notificationPayload' variable - this JSON object contains the necessary information to determine whether to send an email, a text message, or both. It can also send multiple emails and/or text messages.  
* 'initiatedBy' variable - this is the email address of the person who has triggered the subprocess, this would normally be the person who has submitted the form.

For each of these pieces of data it is necessary to go to the Input/Output tab and enter the 'Source' variable that is required in the 'Variables' tab.

### 'notificationPayload' variable

Before you configure the variable mappings for the subprocess you will need to set up the data that will be used in the 'Variables' tab.
The 'notificationPayload' needs a data structure that resembles the following:


```
{
"businessKey" :  "A unique business key",
"email": {
    "subject":  "Subject of the email",
    "body" : "HTML string of the email body",
    "recipients": [   "recipient1@example.com","recipient2@example.com"],
    "attachmentUrls" : [
      "https://file-service/files/testFile.pdf",
      "formPdf.pdf"
    ]
},
"sms" : {
  "message" : "Text message",
  "phoneNumbers": [
      "00447XXXXXXX"
  ]
 }
}
```

It is possible to have either an 'email' section or an 'sms' section or both, as in the example. The mandatory requirements for the email section is the 'recipients'. If 'subject' and 'body' need to be customised then they need to be included here. Otherwise default 'subject' and 'body' will be generated and the only specified attribute will be 'recipients'. There might also be attachments to an email (although not to an SMS). The attachment can be an absolute URL or the key to the file that is stored in the PDF S3 bucket. This bucket configuration would have been set up as a part of the workflow engine deployment. It is also possible to send a PDF of the form as an attachment.

The mandatory requirements for the SMS are the 'message' and 'phoneNumbers'. If you don't want to send an SMS do not include the SMS attribute. If you only want to send an SMS and not an email then don't include the 'email' attribute.

In order to configure the variable mappings, first select the Input/Output tab. Then click on the 'plus' sign above the 'Input Parameters' box. This renders a section 'Input Parameter' with a 'Name', 'Type', and 'Value'. Change the input in the 'Name' box to a name of your choice. Our example is 'notificationPayload'. Change the 'Type' from 'Text' to 'Script' in the dropdown box. This then provides some updated options 'Script Format', 'Script Type', and 'Script'. In the 'Script Format' type in 'groovy', and then the following, using the attributes specific to the form  e.g. 'managerEmail':

```
def holidayRequest = execution.getVariable('holidayRequest');

def businessKey = holidayRequest.prop('businessKey').stringValue();
def requester = holidayRequest.prop('requester').stringValue();

def body = "${requester} has requested a holiday"
def smsMessage = "${requester} has requested a holiday"

def notificationPayload = """
    {
      "businessKey": "${businessKey}",
      "email" : {
        "body": "${body}",
        "subject": "Holiday request",
        "recipients" : [
            ${${holidayRequest.prop('managerEmail').stringValue()}
        ]
      },
      "sms" : {
        "message" : "${smsMessage}",
        "phoneNumbers": [
            ${holidayRequest.prop('managerPhone').stringValue()}
        ]
      }
    }""".toString();
notificationPayload
```

Having done that click on the 'Variables' tab. Click on the plus sign above the 'In Mapping' box. Boxes labelled 'Type', 'Source' and 'Target' will appear.

In the 'Source' box, use the name that you configured in the Input/Output mapping. So in our example that is 'notificationPayload'. This means in your BPMN there is a variable called 'notificationPayload'.

In the 'Target' box add 'notificationPayload'. **This must be used in every situation.**

![notification variable mapping]({{'/images/notification-variable-mapping.jpeg' | relative_url }})

**Figure 4. Subprocess 'send-notifications' variable mapping**

The above 'notificationPayload' will be used by the subprocess to send both an email and an sms message to the manager notifying them of a new holiday request.

#### Adding attachments

Even if a PDF of a form has been generated and sent to all recipients any attachments to that form will need to be sent separately, as a PDF cannot have attachments. This is achieved by sending a copy of the form as an email attachment. The attachments to the form will appear as separate attachments to the email.


![PDF plus notify]({{'/images/pdf-plus-notify.jpeg' | relative_url }})

**Figure 5. Generate PDF and send notification**

This generates the PDF of the form but instead of sending it straight away it returns back a variable that contains the id of the form that is stored in the PDF S3 bucket. This id will be added to a collection as well as any attachments associated with the form.


![PDF variable out mapping]({{'/images/pdf-variable-outmapping.jpeg' | relative_url }})

**Figure 6. Attachment ID variable 'Out Mapping'**

The 'Out Mapping' takes the attachment ids from the 'generate PDF' subprocess and stores them in a new variable called 'attachmentUrls'.

It is possible to add attachments to the email/s by using the code below, following the 'if' conditional statement. In this example you are taking the attachments from the form and passing the urls into a collection which will be used by the 'send-notifications' subprocess to send the email/s with attachments.


```
def attachmentUrls = execution.getVariable('attachmentUrls')
def attachments = org.camunda.spin.Spin.JSON("[]");

if (holidayRequest.hasProp("attachments")) {
    holidayRequest.prop("attachments").elements().each {
        it -> attachments.append(it.prop("url").stringValue())
    }
}

def notificationPayload = """
    {
      "businessKey": "${businessKey}",
      "email" : {
        "body": "${body}",
         "subject": "Approve/Reject Holiday request",
         "attachmentUrls": ${attachments.toString()}
         "recipients" : [
            ${holidayRequest.prop('managerEmail').stringValue()}
         ]
      },
      "sms" : {
        "message" : "${smsMessage}",
        "phoneNumbers": [
             ${holidayRequest.prop('managerPhone').stringValue()}
        ]
      }
    }""".toString();
notificationPayload
```



### 'initiatedBy' variable

This variable contains the data of the person who has initiated the subprocess. This can be data extracted from the form or the variable from the main BPMN.

![initiated by variable mapping]({{'/images/initiated-by-variable-mapping.jpeg' | relative_url }})

**Figure 7. 'initiatedBy' variable mapping**

In this example the process variable 'initiatedBy' is passed into the subprocess. This value can be customised by extracting it from other sources.

## Testing your BPMN

If you need to write a test for your BPMN do not include the subprocess in your testing, because that has already been tested thoroughly and is known to work, and it has its own testing framework. Instead you need to create a 'stub' that mimics the call process so you can test all the other parts of your BPMN end to end.
