---
category: Workflow
expires: 2020-12-31
order: 6
---
# Generating a PDF of a Form

## Introduction

Certain types of form, when completed by a user, generate a PDF of the specific instance of the filled in form, which is then uploaded to Amazon S3. This grew out of the need to disseminate copies of forms via email to specific individuals or teams.
There is a ready-made, reusable BPMN sub-process, that can be incorporated into the BPMN for any form, and that will result in the creation of a PDF version of that form whenever it is submitted.

## PDF generation sub-process - overview

**You do not need to define activities in your BPMN to generate a PDF because there is an existing reusable BPMN sub-process that does all this for you. The following explanation is for information only.**

The main active components of the reusable BPMN sub-process are: BPMN, [Form API Service]('https://github.com/DigitalPatterns/form-api-server'), [Redis]('https://redis.io'), [Puppeteer]('https://github.com/puppeteer/puppeteer'), and the [PDF Service]('https://github.com/DigitalPatterns/pdf-generator'). The initiator is the reusable BPMN sub-process. This sends a request to the Form API Service for PDF generation. This then creates a job that is put onto Redis. The PDF Service is notified of the job. The PDF service then executes the job by running Puppeteer, which opens a headless browser and renders the form with the submission data. A PDF is then generated and, if it is successful, the PDF Service will upload the document to Amazon S3.
Once the document has been successfully uploaded to S3, the PDF Service will notify the 'caller/initiator' of the location of the PDF document. A Webhook URL has been provided for the PDF Service to notify the 'caller/initiator'.


## How to configure the PDF generation sub-process

You will have built a BPMN for your form [in the usual way]({{'/guides/workflow/simple-form-bpmn' | relative_url }}).

In order for your BPMN to create a PDF you need to drag and drop a 'Create Task' icon onto your diagram. Click on the 'spanner' icon to change the type to 'Call Activity'.

![call activity]({{'/images/call-activity.jpeg' | relative_url }})

**Figure 1. 'Call activity' containing the 'Generate PDF' subprocess**

Then fill in the 'Call activity' details panel. You need to specify which 'Call activity' you want to apply. First fill in the type of call activity you are invoking. Select BPMN from the drop-down list. Then in the 'Called Element' input box type in 'generate-case-pdf'. **You need to tick the 'Business Key' check box.** This will populate the 'Business Key Expression' box:

```
#{execution.processBusinessKey}
```

The 'Business Key' is autogenerated when a user submits a form. This is to enable 'Case View'. When a 'Business Key' is inputted into 'Case View' it will then return all process instances associated with that key. This provides a full audit trail for every case.  

![call activity details panel]({{'/images/call-activity-details-panel.jpeg' | relative_url }})

**Figure 2. Call activity details panel on the 'General' tab**

**In addition tick the 'Asynchronous before' box and the 'Exclusive' box. If you don't make the 'Call activity'  'Asynchronous' the subprocess will try to retrieve the data from S3 before the data has been saved. Ticking the 'Exclusive' box ensures that if multiple instances of the workflow are running only one person can execute the job, preventing duplicate execution.**

![asynchronous before box]({{'/images/async-subprocess.jpeg' | relative_url }})

**Figure 3. Ticked 'Asynchronous before' box and 'Exclusive' box**


At this point you have configured your BPMN to call your reusable subprocess. If you stopped here the reusable subprocess would be called but then it would do nothing because it needs a set of variable inputs to execute.

### Variable input mapping

On the 'Variables' tabs of the 'Call activity' you are going to configure the input mappings for the subprocess, i.e. you are going to give the subprocess a set of data for it to execute.
The subprocess needs four pieces of data.

* 'generateCasePdf' variable - a collection of form references that require PDFs.
* 'recipients' variable - a list of email addresses you want the PDFs to be sent to.
* 'messageBody' variable - this is the content of the email that will be populated when the PDFs are sent as attachments.
* 'messageSubject' variable - to populate the email subject box.

For each of these pieces of data it is necessary to go to the Input/Output tab and enter the 'Source' variable that is required in the 'Variables' tab.

### 'generateCasePdf' variable

**Your form data is stored as a variable in the process instance with the same name as the 'Form key' that you configured at the start of the BPMN.**

You need to begin by inputting the variable that will call the 'submitted form metadata'. This metadata contains the form version ID, the form ID, the title of the form, the name of the form, the date on which the form was submitted, and the email address of the person who submitted the form. This metadata provides some of the data for the PDF generation.

Before you configure the variable mappings for the subprocess you will need to set up the data that will be used in the variables tab. So, first select the Input/Output tab. Then click on the 'plus' sign above the 'Input Parameters' box. This renders a section 'Input Parameter' with a 'Name', 'Type', and 'Value'. Change the input in the 'Name' box to a name of your choice. Our example is 'formsForPdf'. Change the 'Type' from 'Text' to 'Script' in the dropdown box. This then provides some updated options 'Script Format', 'Script Type', and 'Script'. In the 'Script Format' type in 'groovy'. In the 'Script' box you need to extract the submitted form metadata and add it to a collection. You can use Groovy or Javascript to write some code that will harvest the 'BusinessKey' and the 'forms' metadata.

```
def formFragment = myForm.prop('form')
def caseBusinessKey = myForm.prop("businessKey").stringValue()

def data = """{
"caseBusinessKey" : "${caseBusinessKey}",
"forms" : [${formFragment.toString()}]

}""".toString()
S(data)
```

The first line of the above Groovy code calls all the information on the form as the variable 'myForm' and then the second line extracts the metadata contained in the variable 'myForm'. The third line pulls the 'BusinessKey' from the form. The fourth, fifth, and sixth lines create a new data structure that contains the 'Business Key' and the 'forms' metadata. The last two lines return the data to the 'Input Name'.


Having done that click on the 'Variables' tab. Click on the plus sign above the 'In Mapping' box. Boxes labelled 'Type', 'Source' and 'Target' will appear.

In the 'Source' box, use the name that you configured in the Input/Output mapping. So in our example that is 'formsForPdf'. This means in your BPMN there is a variable called 'formsForPdf'.

In the 'Target' box add 'generateCasePdf'. **This must be used in every situation.**

![variable mapping]({{'/images/variable-mapping.jpeg' | relative_url }})

**Figure 4. Subprocess 'generateCasePdf' variable mapping**

### 'recipients' variable
The PDF has been generated and uploaded to S3. The subprocess now needs to know who to send the PDF attachments to. First go to the Input/Output tab and, as for the 'generateCasePdf' variable give the variable name in the 'Input parameters' box, e.g. 'recipients'. Go to the Input/Output tab and in the 'Script' box type the Groovy code that will build the 'recipients' list. Below is an example.

```
def lineManager = execution.getVariable('myForm').prop("lineManagerEmail").stringValue();
def submitter = execution.getVariable('myForm').prop("form").prop("submittedBy").stringValue();
def recipients = [submitter, lineManager];
recipients
```

In the above code the 'recipients' are the line manager email, and the person who submitted the form. Your recipients will depend on the use case of the form you are building.
Next go back to the 'Variables' tab and map the 'recipients' to the target source. In the 'Target' box add 'recipients'. **This must be used in every circumstance**

![recipients variable]({{'/images/recipients-variable.jpeg' | relative_url }})

**Figure 5. 'recipients' variable**

### 'messageBody' variable

You have to provide a message that will go in the body of the email that the recipients of the PDF form will read.
To do this proceed as before. In the Input/Output tab give the variable a name, e.g. 'emailBody'. Then in the 'Script' box enter a string that contains html. Below is an example Groovy string containing an html message:

```
def messageBody = """<html>
<head>
</head>
<body>
<p>Dear User</p>

<p>Please find submitted form attached.</p>
<p>Kind regards</p>
<p>Sender</p>
</body>
</html>"""

messageBody
```

You can configure your message according to your specific use case. This may including extracting information from the form. The following is an example that extracts information from the form.

```
def messageBody = """<html>
<head>
</head>
<body>
<p>Dear User</p>

<p>Please find the record  for reference  ${S(myForm).prop('businessKey').stringValue()} </p>
<p>Kind regards</p>
<p>Sender</p>
</body>
</html>"""

messageBody
```

The above code uses the 'businessKey' from the form and adds it to the message body. You can follow the same approach for other pieces of information from the form.

![message body variable]({{'/images/message-body-variable.jpeg' | relative_url }})

**Figure 5. 'messageBody' variable**

Next go back to the 'Variables' tab and map the 'messageBody' to the target source. In the 'Target' box add 'messageBody'. **This must be used in every circumstance**

### 'messageSubject' variable

You have to provide a subject that will go in the email subject line.
To do this proceed as before. In the Input/Output tab give the variable a name, e.g. 'emailSubject'.

On the 'Input/Output' tab in the box 'Value' under 'Input parameter' write the following string:


```
A form has been submitted with reference: ${S(myForm).prop('businessKey').stringValue()}
```
![message subject variable value]({{'/images/subject-variable-value.jpeg' | relative_url }})

**Figure 6. 'emailSubject' 'Input Parameter' mapping**

Next go back to the 'Variables' tab and map the 'messageSubject' to the target source. In the 'Target' box add 'messageSubject'. **This must be used in every circumstance**

![message subject variable]({{'/images/message-subject-variable.jpeg' | relative_url }})

**Figure 7. 'messageSubject' variable**

## Testing your BPMN

If you need to write a test for your BPMN do not include the subprocess in your testing, because that has already been tested thoroughly and is known to work, and it has its own testing framework. Instead you need to create a 'stub' that mimics the call process so you can test all the other parts of your BPMN end to end.
